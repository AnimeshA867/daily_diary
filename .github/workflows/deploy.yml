name: Deploy to AWS Production
on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3 # Use a specific version for stability
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          # 1. Tell the action which local env variables to pass to AWS
          envs: PROD_ENV_CONTENT
          # 2. Use the pipe (|) for multi-line scripts to avoid 'unexpected value'
          script: |
            # Navigate to your project
            cd ~/daily_diary || { echo "Directory not found"; exit 1; }

            # Pull latest code
            git pull origin master

            # Create the production env file
            # Wrapping PROD_ENV_CONTENT in quotes is what preserves your 50+ lines
            echo "$PROD_ENV_CONTENT" > .env.production

            # Verification check
            echo "Env file updated. Bytes: $(stat -c%s .env.production)"

            # Rebuild and restart Docker containers
            docker compose -f docker-compose.yml down
            docker compose -f docker-compose.yml up -d --build
        env:
          # 3. Map the secret to a variable here (outside the 'with' block)
          PROD_ENV_CONTENT: ${{ secrets.ENV_FILE }}
